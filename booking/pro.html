<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Dashboard for LawGlitch consultations">
    <title>Professional Dashboard - LawGlitch</title>
    <!-- Use production React in production -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--cream) 0%, var(--white) 100%);
            min-height: 100vh;
        }
        .dashboard-container {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }
        .bookings-list { 
            display: grid; 
            gap: 20px; 
            margin-top: 30px; 
        }
        .booking-card { 
            background: var(--white);
            border: 1px solid var(--light-gray);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        .booking-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .booking-actions { 
            display: flex; 
            gap: 15px; 
            margin-top: 15px;
            flex-wrap: wrap;
        }
        button { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 30px; 
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }
        .accept-btn { 
            background: var(--gold); 
            color: var(--white);
        }
        .schedule-btn { 
            background: var(--black); 
            color: var(--white);
        }
        .reject-btn { 
            background: #dc3545; 
            color: var(--white);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .modal { 
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0;
            bottom: 0;
            width: 100%; 
            height: 100vh; 
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-content { 
            background: var(--white); 
            position: relative;
            width: 100%;
            max-width: 600px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 20px;
            color: var(--dark-gray);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 36px;
            height: 36px;
        }
        .modal-close:hover {
            background: rgba(0,0,0,0.1);
            transform: rotate(90deg);
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .section-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 10px;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            color: var(--dark-gray);
            position: relative;
        }
        .tab-button.active {
            color: var(--gold);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gold);
        }
        .notification-dot {
            position: relative;
        }
        .notification-dot::before {
            content: '';
            position: absolute;
            top: 0;
            right: -5px;
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Wait for config.js to load and setup global config
        window.onload = function() {
            console.log('Config loaded:', window.config);
            if (!window.config) {
                console.error('Config failed to load!');
            }
        };
    </script>
    <script src="../chatroom/config.js"></script>
    <script type="text/babel">
        const { createClient } = supabase;        const supabaseClient = createClient(
            'https://pxwbumtpnzbbqzqhnsow.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4d2J1bXRwbnpiYnF6cWhuc293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjM4NTcsImV4cCI6MjA3MzgzOTg1N30.CfDyCEQCCoc4p1KrE_G43ToVGExuVvGAGWk3hMQxf3s'
        );

        // Initialize video meeting manager
        window.videoMeetingManager = {
            async createMeeting(bookingId) {
                try {
                    if (!window.config) {
                        throw new Error('Meeting configuration not loaded');
                    }

                    const response = await fetch(window.config.EDGE_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.config.getHeaders()
                        },
                        body: JSON.stringify({
                            booking_id: bookingId,
                            action: 'create_meeting'
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to create meeting: ${errorText}`);
                    }

                    const data = await response.json();
                    return {
                        roomId: data.roomId,
                        token: data.token
                    };
                } catch (error) {
                    console.error('Error creating meeting:', error);
                    throw error;
                }
            },

            redirectToMeeting(roomId, token, booking, isPro = false) {
                const path = window.location.pathname.includes('/booking/') 
                    ? '../chatroom/pro-chat.html'
                    : '/chatroom/pro-chat.html';
                const url = `${path}?booking=${booking.id}&room_id=${roomId}&token=${token}`;
                window.location.href = url;
            }
        };

        function BookingCard({ booking, onAccept, onSchedule, onReject, animate }) {
            function joinRoom(room_id, type) {
                const chatroomPath = window.location.pathname.includes('/booking/') 
                    ? '../chatroom/pro-chat.html'
                    : '/chatroom/pro-chat.html';
                
                const url = `${chatroomPath}?room_id=${room_id}&type=${type}`;
                window.location.href = url;
            }

            return (
                <div className="booking-card" style={ animate ? { animation: 'fadeIn 0.5s ease-out' } : {} }>
                    {booking.scheduled_for && (
                        <p style={{
                            fontWeight: 'bold',
                            fontSize: '1.1em',
                            color: '#1a73e8',
                            marginBottom: '15px',
                            padding: '10px',
                            background: '#f8f9fa',
                            borderRadius: '6px'
                        }}>
                            Scheduled for: {new Date(booking.scheduled_for).toLocaleString(undefined, {
                                dateStyle: 'full',
                                timeStyle: 'long',
                            })}
                        </p>
                    )}
                    <h3>{booking.client_name}</h3>
                    <p>Email: {booking.client_email}</p>
                    <p>Duration: {booking.duration} minutes</p>
                    <p>Medium: {booking.medium}</p>
                    <p>Urgency: {booking.urgency}</p>
                    
                    <div className="booking-actions">
                        <button 
                            className="accept-btn" 
                            onClick={() => onAccept(booking)}
                        >
                            Accept
                        </button>
                        <button 
                            className="schedule-btn" 
                            onClick={() => onSchedule(booking)}
                        >
                            Schedule
                        </button>
                        <button 
                            className="reject-btn" 
                            onClick={() => onReject(booking)}
                        >
                            Reject
                        </button>
                    </div>
                    
                </div>
            );
        }

        function ProfessionalDashboard() {
            const [bookings, setBookings] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [showModal, setShowModal] = React.useState(false);
            const [selectedBooking, setSelectedBooking] = React.useState(null);
            const [modalType, setModalType] = React.useState('');
            // Ref to keep the last rendered bookings snapshot to avoid visual reloads
            const lastRenderedBookingsRef = React.useRef(null);
            // Flag to indicate first full load (show loading UI only once)
            const initialLoadRef = React.useRef(true);
            const defaultSchedulingTemplate = {
                id: 'scheduling-template',
                name: 'Meeting Schedule Template',
                content: `Dear {client_name},

I would like to schedule our {booking_type} consultation for:
[scheduled_datetime]

You can join the consultation using the link below:
[meeting_link]

Best regards`,
                isDefault: true
            };
            
            const [templates, setTemplates] = React.useState([defaultSchedulingTemplate]);
            const [templateDraft, setTemplateDraft] = React.useState({});
            const [modalTemplate, setModalTemplate] = React.useState('');
            const [activeTab, setActiveTab] = React.useState('bookings');

            const urlParams = new URLSearchParams(window.location.search);
            const proId = urlParams.get('pro_id') || 'pro_123';

            // Function to clear the bookings cache and reset last-rendered snapshot
            const clearBookingsCache = () => {
                const cacheKey = `bookings_${proId}_${activeTab}`;
                localStorage.removeItem(cacheKey);
                localStorage.removeItem(`${cacheKey}_timestamp`);
                lastRenderedBookingsRef.current = null;
            };

            React.useEffect(() => {
                // Clear cache when tab changes
                clearBookingsCache();
                fetchBookings();
                const interval = setInterval(fetchBookings, 5000); // Short-polling every 5 seconds

                // Add message listener for notify modal
                const handleMessage = (event) => {
                    if (event.data.action === 'open_notify_modal') {
                        const booking = event.data.booking;
                        setSelectedBooking(booking);
                        setModalType('notify');
                        const meetingLink = `${window.location.origin}/chatroom/index.html?room_id=${booking.id}&type=client&auto_join=true`;
                        const notifyTemplate = `Hi ${booking.client_name || 'Client'},

I have joined the meeting room and am ready for our consultation.

Please join me using this link:
${meetingLink}

Looking forward to our session!

Best regards,`;
                        setModalTemplate(notifyTemplate);
                        setShowModal(true);
                    }
                };
                window.addEventListener('message', handleMessage);

                return () => {
                    clearInterval(interval);
                    window.removeEventListener('message', handleMessage);
                };
            }, [proId, activeTab]); // Add activeTab to dependencies

            // After first render, ensure that initialLoadRef is false so future updates are silent
            React.useEffect(() => {
                if (initialLoadRef.current && bookings.length > 0) {
                    initialLoadRef.current = false;
                }
            }, [bookings]);

            const fetchBookings = async () => {
                try {
                    const cacheKey = `bookings_${proId}_${activeTab}`;
                    const cachedData = localStorage.getItem(cacheKey);
                    const cachedTimestamp = localStorage.getItem(`${cacheKey}_timestamp`);

                    // If we have cached data and it's fresh, compare with lastRendered and bail out if same
                    if (cachedData && cachedTimestamp && (Date.now() - parseInt(cachedTimestamp)) < 5000) {
                        const parsedData = JSON.parse(cachedData) || [];
                        const lastRendered = lastRenderedBookingsRef.current;

                        // If we've already rendered this snapshot, do nothing (silent refresh)
                        if (lastRendered && JSON.stringify(lastRendered) === JSON.stringify(parsedData)) {
                            return;
                        }

                        // If initial load, set state and mark initialLoadRef false to allow UI
                        if (initialLoadRef.current) {
                            setBookings(parsedData);
                            lastRenderedBookingsRef.current = parsedData;
                            initialLoadRef.current = false;
                            setLoading(false);
                            return;
                        }

                        // Otherwise update state (data changed)
                        setBookings(parsedData);
                        lastRenderedBookingsRef.current = parsedData;
                        return;
                    }

                    // Fetch fresh data from server
                    // During polling we avoid toggling loading UI to prevent flicker
                    if (initialLoadRef.current) setLoading(true);

                    const { data, error } = await supabaseClient
                        .from('bookings')
                        .select('*')
                        .eq('pro_id', proId)
                        .eq('meeting_status', activeTab === 'scheduled' ? 'scheduled' : 'pending')
                        .order('scheduled_for', { ascending: true });

                    if (error) throw error;

                    const dataArr = data || [];

                    // Cache the new data
                    localStorage.setItem(cacheKey, JSON.stringify(dataArr));
                    localStorage.setItem(`${cacheKey}_timestamp`, Date.now().toString());

                    const lastRendered = lastRenderedBookingsRef.current;

                    // If identical to last rendered snapshot, don't update state (silent)
                    if (lastRendered && JSON.stringify(lastRendered) === JSON.stringify(dataArr)) {
                        if (initialLoadRef.current) {
                            // On first load make sure to set state at least once
                            setBookings(dataArr);
                            initialLoadRef.current = false;
                            setLoading(false);
                        } else {
                            // No visual update required
                            setLoading(false);
                        }
                        return;
                    }

                    // Data changed -> update UI and snapshot
                    setBookings(dataArr);
                    lastRenderedBookingsRef.current = dataArr;
                    initialLoadRef.current = false;
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const handleAccept = async (booking) => {
                try {
                    // Update the booking status to 'ready' in Supabase
                    const { error } = await supabaseClient
                        .from('bookings')
                        .update({ meeting_status: 'ready' })
                        .eq('id', booking.id);

                    if (error) throw error;

                    // Send message to parent window to switch to active meetings and fill inputs
                    window.parent.postMessage({
                        action: 'accept_booking',
                        booking: {
                            id: booking.id,
                            client_name: booking.client_name,
                            client_email: booking.client_email
                        }
                    }, '*');

                    console.log('Booking accepted and status updated to ready');
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleSchedule = async (booking) => {
                setSelectedBooking(booking);
                setModalType('schedule');
                
                // Get current date/time formatted for datetime-local input
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);

                // Set up the scheduling template using the default template
                const schedulingTemplate = templates.find(t => t.id === 'scheduling-template');
                const processedTemplate = schedulingTemplate.content
                    .replace('{client_name}', booking.client_name)
                    .replace('{booking_type}', booking.medium);
                setModalTemplate(processedTemplate);
                
                // Store the selected datetime
                setTemplateDraft({
                    ...templateDraft,
                    scheduledDateTime: localDateTime
                });
                
                setShowModal(true);
            };

            const handleReject = (booking) => {
                setSelectedBooking(booking);
                setModalType('reject');
                // Set default rejection template with variables
                setModalTemplate(
                    `Dear {client_name},\n\n` +
                    `Thank you for your {booking_type} consultation request for {duration} minutes. ` +
                    `I regret to inform you that I am unable to accept your booking at this time.\n\n` +
                    `[Please provide a brief reason for the rejection]\n\n` +
                    `If you would like to schedule for a later date or explore alternative consultation options, ` +
                    `please feel free to submit a new booking request.\n\n` +
                    `I apologize for any inconvenience and appreciate your understanding.\n\n` +
                    `Best regards`
                );
                setShowModal(true);
            };

            const confirmReject = async () => {
                try {
                    // First send the email
                    sendEmail();
                    
                    // Then update the booking status
                    const { error } = await supabaseClient
                        .from('bookings')
                        .update({ 
                            meeting_status: 'rejected',
                            rejection_reason: modalTemplate // Store the rejection reason
                        })
                        .eq('id', selectedBooking.id);
                    
                    if (error) throw error;
                    clearBookingsCache(); // Clear cache before closing modal
                    setShowModal(false);
                } catch (err) {
                    setError(err.message);
                }
            };

            const sendEmail = () => {
                if (!selectedBooking || !modalTemplate) {
                    setError('Please enter a message before sending.');
                    return;
                }

                let subject;
                if (modalType === 'reject') {
                    subject = 'Booking Request Update';
                } else if (modalType === 'notify') {
                    subject = 'Meeting Ready - I Have Joined';
                } else {
                    subject = 'Meeting Schedule Request';
                }

                const processedTemplate = modalTemplate
                    .replace('{client_name}', selectedBooking.client_name)
                    .replace('{booking_type}', selectedBooking.medium)
                    .replace('{duration}', selectedBooking.duration);

                const body = encodeURIComponent(processedTemplate);
                const mailTo = selectedBooking.client_email;

                // For mobile devices, open in Gmail app
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${mailTo}&su=${encodeURIComponent(subject)}&body=${body}`, '_blank');
                } else {
                    window.location.href = `mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${body}`;
                }

                if (modalType === 'reject') {
                    // For reject, the modal will be closed by confirmReject
                    return;
                }
                setShowModal(false);
            };

            const renderBookings = () => {
                if (loading) return <p>Loading bookings...</p>;
                if (error) return <p style={{ color: 'red' }}>Error: {error}</p>;
                
                return (
                    <div className="bookings-list">
                        {bookings.map((booking, index) => (
                            <BookingCard
                                key={`${booking.id}-${index}`}
                                booking={booking}
                                onAccept={handleAccept}
                                onSchedule={handleSchedule}
                                onReject={handleReject}
                                animate={initialLoadRef.current}
                            />
                        ))}
                    </div>
                );
            };

            return (
                <div className="dashboard-container">
                    <div className="section-tabs">
                        <button 
                            className={`tab-button ${activeTab === 'bookings' ? 'active' : ''} ${bookings.some(b => b.meeting_status === 'pending') ? 'notification-dot' : ''}`}
                            onClick={() => setActiveTab('bookings')}
                        >
                            Bookings
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'scheduled' ? 'active' : ''}`}
                            onClick={() => setActiveTab('scheduled')}
                        >
                            Scheduled
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'templates' ? 'active' : ''}`}
                            onClick={() => setActiveTab('templates')}
                        >
                            Email Templates
                        </button>
                    </div>

                    {(activeTab === 'bookings' || activeTab === 'scheduled') && renderBookings()}

                    {activeTab === 'templates' && (
                        <div className="templates-section">
                            <h2>Email Templates</h2>
                            <p>Create and manage your email templates for quick responses.</p>
                            
                            <div className="template-card">
                                <h3>New Template</h3>
                                <div style={{ marginTop: '15px' }}>
                                    <input 
                                        type="text" 
                                        placeholder="Template Name" 
                                        value={templateDraft.name || ''}
                                        onChange={(e) => setTemplateDraft({
                                            ...templateDraft,
                                            name: e.target.value
                                        })}
                                        style={{ marginBottom: '10px' }}
                                    />
                                    <textarea 
                                        value={templateDraft.content || ''}
                                        onChange={(e) => setTemplateDraft({
                                            ...templateDraft,
                                            content: e.target.value
                                        })}
                                        placeholder="Template content... Use {client_name}, {pro_name} as placeholders"
                                        rows={6}
                                        style={{ 
                                            width: '100%',
                                            padding: '10px',
                                            borderRadius: '8px',
                                            border: '1px solid var(--light-gray)',
                                            marginBottom: '10px'
                                        }}
                                    />
                                    <button 
                                        onClick={() => {
                                            if (!templateDraft.name || !templateDraft.content) {
                                                setError('Please fill in both name and content');
                                                return;
                                            }
                                            setTemplates([...templates, { ...templateDraft, id: Date.now() }]);
                                            setTemplateDraft({});
                                        }}
                                        className="accept-btn"
                                        style={{ width: '100%' }}
                                    >
                                        Save Template
                                    </button>
                                </div>
                            </div>

                            <div style={{ marginTop: '30px' }}>
                                <h3>Saved Templates</h3>
                                {templates.map(template => (
                                    <div key={template.id} className="template-card">
                                        <h4>{template.name}</h4>
                                        <p style={{ 
                                            margin: '10px 0', 
                                            padding: '10px', 
                                            background: 'var(--white)',
                                            borderRadius: '8px'
                                        }}>
                                            {template.content}
                                        </p>
                                        <div style={{ display: 'flex', gap: '10px' }}>
                                            <button 
                                                onClick={() => setTemplateDraft(template)}
                                                className="schedule-btn"
                                            >
                                                Edit
                                            </button>
                                            {!template.isDefault && (
                                                <button 
                                                    onClick={() => {
                                                        setTemplates(templates.filter(t => t.id !== template.id));
                                                    }}
                                                    className="reject-btn"
                                                >
                                                    Delete
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Settings section removed as OAuth is handled elsewhere */}

                    {showModal && (
                        <div className="modal" onClick={(e) => {
                            // Close modal when clicking outside
                            if (e.target === e.currentTarget) {
                                setShowModal(false);
                            }
                        }}>
                            <div className="modal-content">
                                <button 
                                    className="modal-close" 
                                    onClick={() => setShowModal(false)}
                                    title="Close"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                                <h2>
                                    {modalType === 'reject' ? 'Reject Booking' :
                                     modalType === 'notify' ? 'Notify Client Joined' :
                                     'Schedule Meeting'} - {selectedBooking?.client_name}
                                </h2>
                                {modalType === 'schedule' && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ display: 'block', marginBottom: '10px' }}>
                                            Select Date and Time for the Meeting:
                                        </label>
                                        <input
                                            type="datetime-local"
                                            value={templateDraft.scheduledDateTime || ''}
                                            onChange={(e) => {
                                                const newDateTime = e.target.value;
                                                setTemplateDraft({
                                                    ...templateDraft,
                                                    scheduledDateTime: newDateTime
                                                });

                                                // Format the date for display
                                                const formattedDate = new Date(newDateTime).toLocaleString();

                                                // Update template with selected datetime
                                                const updatedTemplate = modalTemplate
                                                    .replace(/\[scheduled_datetime\].*/, `[scheduled_datetime]${formattedDate}`);
                                                setModalTemplate(updatedTemplate);
                                            }}
                                            style={{
                                                width: '100%',
                                                padding: '10px',
                                                borderRadius: '8px',
                                                border: '1px solid var(--light-gray)',
                                                marginBottom: '10px'
                                            }}
                                            min={new Date().toISOString().slice(0, 16)}
                                        />
                                    </div>
                                )}
                                {modalType === 'notify' && (
                                    <p>Send a notification email to inform the client that you have joined the meeting.</p>
                                )}
                                <textarea 
                                    value={modalTemplate} 
                                    onChange={(e) => setModalTemplate(e.target.value)}
                                    rows={10} 
                                    style={{ width: '100%', margin: '10px 0', padding: '10px' }}
                                    placeholder="Enter your message..."
                                />
                                <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                    {modalType === 'schedule' && templateDraft.scheduledDateTime && (
                                        <button 
                                            onClick={async () => {
                                                try {
                                                    const formattedDate = new Date(templateDraft.scheduledDateTime)
                                                        .toLocaleString();
                                                    
                                                    // Create the meeting URL with absolute path
                                                    const meetingLink = `${window.location.origin}/chatroom/index.html?room_id=${selectedBooking.id}&type=client&auto_join=true`;
                                                    
                                                    // First update the booking with scheduled time
                                                    const { error: updateError } = await supabaseClient
                                                        .from('bookings')
                                                        .update({ 
                                                            scheduled_for: templateDraft.scheduledDateTime,
                                                            meeting_status: 'scheduled'
                                                        })
                                                        .eq('id', selectedBooking.id);
                                                    
                                                    if (updateError) throw updateError;

                                                    // Format email template with meeting link
                                                    const emailContent = modalTemplate
                                                        .replace('[scheduled_datetime]', formattedDate)
                                                        .replace('[meeting_link]', `
<div style="text-align:center; margin: 20px 0;">
    <a href="${meetingLink}" 
       style="background-color: #4CAF50; 
              color: white; 
              padding: 12px 20px; 
              text-decoration: none; 
              border-radius: 5px; 
              display: inline-block;">
        Join Meeting
    </a>
</div>`);

                                                    const subject = encodeURIComponent('Meeting Scheduled -Session Time & Date');
                                                    const mailTo = selectedBooking.client_email;
                                                    const body = encodeURIComponent(emailContent);

                                                    // For mobile devices
                                                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                                                    
                                                    if (isMobile) {
                                                        // Try to open Gmail app first
                                                        const gmailUrl = `googlegmail://co?to=${mailTo}&subject=${subject}&body=${body}`;
                                                        window.location.href = gmailUrl;
                                                        
                                                        // Fallback to default mail app after a short delay if Gmail doesn't open
                                                        setTimeout(() => {
                                                            window.location.href = `mailto:${mailTo}?subject=${subject}&body=${body}`;
                                                        }, 500);
                                                    } else {
                                                        // For PC, always open Gmail web in new tab
                                                        const gmailWebUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${mailTo}&su=${subject}&body=${body}`;
                                                        window.open(gmailWebUrl, '_blank');
                                                    }
                                                    
                                                    clearBookingsCache(); // Clear cache before fetching
                                                    await fetchBookings(); // Refresh the bookings list
                                                    setShowModal(false);
                                                } catch (err) {
                                                    setError(err.message);
                                                }
                                            }}
                                            style={{
                                                background: '#4CAF50',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '8px',
                                                opacity: templateDraft.scheduledDateTime ? 1 : 0.5,
                                                cursor: templateDraft.scheduledDateTime ? 'pointer' : 'not-allowed'
                                            }}
                                            disabled={!templateDraft.scheduledDateTime}
                                        >
                                            <i className="fas fa-bell"></i>
                                            Send Schedule & Notify
                                        </button>
                                    )}
                                    {modalType === 'notify' && (
                                        <button onClick={sendEmail} style={{background: '#4CAF50'}}>Send Notification</button>
                                    )}
                                    {modalType === 'reject' && (
                                        <button onClick={confirmReject}>
                                            Reject & Send Email
                                        </button>
                                    )}
                                    <button onClick={() => setShowModal(false)} style={{background: '#6c757d'}}>Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProfessionalDashboard />);
    </script>
</body>
</html>