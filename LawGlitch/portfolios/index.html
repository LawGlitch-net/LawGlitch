<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Dashboard - LawGlitch</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="active-meetings.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../join-us/config.js" type="module"></script>
    <script src="editor.js" type="module"></script>
    <script src="app.js" type="module"></script>
    <script src="../ai-agent/ai.js"></script>
</head>
<body>
    <!-- Auth Check Loading State -->
    <div id="auth-loading" class="auth-loading hidden">
        <div class="loading-spinner"></div>
        <p>Checking authentication...</p>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <!-- Auth Required State -->
    <div id="auth-required" class="auth-required hidden">
        <div class="container">
            <h2>Professional Dashboard Access</h2>
            <p id="auth-message">Please sign in to access your dashboard</p>
            <div id="auth-buttons" class="auth-buttons">
                <button id="google-signin" class="google-btn">
                    <i class="fab fa-google"></i>
                    Sign in with Google
                </button>
                <p class="auth-separator">or</p>
                <a href="../join-us/index.html" class="join-btn">
                    <i class="fas fa-user-plus"></i>
                    Create Professional Profile
                </a>
                <p class="auth-note">New to LawGlitch? Create your professional profile to get started.</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1 class="logo">
                    <span class="logo-law">Law</span><span class="logo-glitch">Glitch</span>
                </h1>
            </div>
            <nav class="header-nav">
                <button id="meetings-tab" class="nav-btn active">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Bookings</span>
                </button>
                <button id="active-meetings-tab" class="nav-btn">
                    <i class="fas fa-video"></i>
                    <span>Active Meetings</span>
                </button>
                <button id="editor-tab" class="nav-btn">
                    <i class="fas fa-edit"></i>
                    <span>Editor</span>
                </button>
                <button id="payments-tab" class="nav-btn">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
                <div class="wallet-section" id="wallet-section">
                    <i class="fas fa-coins"></i>
                    <span id="wallet-balance">$0</span>
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="profile-dropdown">
                    <button id="profile-btn" class="profile-btn">
                        <img id="profile-pic" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIwIDIwQzIyLjc2MTQgMjAgMjUgMTcuNzYxNCAyNSAxNUMyNSAxMi4yMzg2IDIyLjc2MTQgMTAgMjAgMTBDMTcuMjM4NiAxMCAxNSAxMi4yMzg2IDE1IDE1QzE1IDE3Ljc2MTQgMTcuNzYxNCAyMCAyMFoiIGZpbGw9IiM5Q0E0QUYiLz4KPHBhdGggZD0iTTMwIDI4QzMwIDI0LjY4NjMgMjYuNDI3MSAyMiAyMiAyMkgxOEMxMy41NzI5IDIyIDEwIDI0LjY4NjMgMTAgMjhWMzBIMzBWMjhaIiBmaWxsPSIjOUNBNEFGRiIvPgo8L3N2Zz4K" alt="Profile" class="profile-pic">
                    </button>
                    <div id="profile-menu" class="profile-menu hidden">
                        <div id="profile-info" class="profile-info">
                            <p id="profile-username">Loading...</p>
                            <p id="profile-email" class="profile-email">Loading...</p>
                        </div>
                        <button id="sign-out" class="sign-out-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="dashboard-content">
            <!-- Meetings Section -->
            <section id="meetings-section" class="dashboard-section">
                <div class="iframe-container">
                    <iframe id="meetings-frame" src="" frameborder="0"></iframe>
                </div>
            </section>

            <!-- Active Meetings Section -->
            <section id="active-meetings-section" class="dashboard-section hidden">
                <div class="active-meetings-container">
                    <div class="meeting-inputs">
                        <label for="booking-id">Booking ID</label>
                        <input type="text" id="booking-id" placeholder="Enter booking ID" onchange="updateMeetingFrame()">

                        <label for="client-name">Name</label>
                        <input type="text" id="client-name" placeholder="Enter name" onchange="updateMeetingFrame()">

                        <label for="client-email">Client's Email</label>
                        <input type="email" id="client-email" placeholder="Enter client's email">
                    </div>
                    <div class="iframe-container">
                        <iframe id="active-meetings-frame" src="../chatroom/index.html?pro_id=default&booking_id=" frameborder="0"></iframe>
                    </div>
                    <script>
                        function updateMeetingFrame() {
                            const frame = document.getElementById('active-meetings-frame');
                            const bookingId = document.getElementById('booking-id').value;
                            const clientName = document.getElementById('client-name').value;
                            const params = new URLSearchParams();
                            
                            // Pass pro_id for professional view context
                            params.set('pro_id', 'default');
                            
                            // Pass actual booking_id for database operations
                            if (bookingId) {
                                params.set('booking_id', bookingId);
                                console.log(`üîÑ Updating iframe with booking_id: ${bookingId}`);
                            }
                            
                            if (clientName) {
                                params.set('client_name', clientName);
                            }
                            
                            // Build the new iframe src with parameters
                            const newSrc = `../chatroom/index.html?${params.toString()}`;
                            console.log('üìç New iframe src:', newSrc);
                            frame.src = newSrc;
                        }

                        // Initial setup when booking ID is pre-filled
                        if (document.getElementById('booking-id').value) {
                            updateMeetingFrame();
                        }
                    </script>
                </div>
            </section>

            <!-- Editor Section -->
            <section id="editor-section" class="dashboard-section hidden">
                <!-- Editor content will be dynamically generated by editor.js -->
            </section>

            <!-- Payments & Analytics Section -->
            <section id="payments-section" class="dashboard-section hidden">
                <div class="payments-container">
                    <div class="payments-header">
                        <h2>Payments & Analytics</h2>
                        <p class="muted">Edit your public payment link used for client checkouts.</p>
                    </div>

                    <div class="payments-main">
                        <label for="payment-email">Email</label>
                        <input id="payment-email" type="text" readonly aria-readonly="true">

                        <label for="payment-link">Payment Link</label>
                        <input id="payment-link" type="url" placeholder="https://" aria-label="Payment link">

                        <div class="payments-actions">
                            <button id="save-payment-link" class="btn btn-primary">Save</button>
                            <button id="reset-payment-link" class="btn btn-secondary">Reset</button>
                        </div>

                        <p class="payments-note muted">Note: This is a client-side update that will write to your `professionals.payment_link` column.</p>
                    </div>
                </div>
            </section>

            <!-- Toast Notifications -->
            <div id="toast-container" class="toast-container"></div>
        </main>
    </div>

    <!-- Wallet Modal -->
    <div id="wallet-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close" id="close-wallet-modal">&times;</span>
            <h3>Wallet</h3>
            <p>Current Balance: <span id="modal-wallet-balance">$0</span></p>
            <div class="wallet-actions">
                <button id="topup-5" class="btn btn-primary">Top Up $5</button>
                <button id="withdraw-5" class="btn btn-secondary">Withdraw $5</button>
            </div>
        </div>
    </div>
</body>
</html>